<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard jakości powietrza – miasta wojewódzkie</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Dashboard jakości powietrza – miasta wojewódzkie</h1>

<div class="panel">

    <div class="control-box">
        <label>Parametr:</label>
        <select id="pollutantSelect"></select>
    </div>

    <div class="control-box">
        <label>Miasta (CMD/CTRL = wiele):</label>
        <select id="citySelect" multiple size="10"></select>
    </div>

    <button id="generateBtn">Generuj wykres</button>

</div>

<h2>Wykres</h2>
<canvas id="chart"></canvas>

<h2>Statystyki</h2>
<table id="statsTable">
    <tr>
        <th>Miasto</th>
        <th>Min</th>
        <th>Max</th>
        <th>Średnia</th>
        <th>Liczba dni</th>
    </tr>
</table>


<script>
let chart = null;

async function loadPollutants() {
    const res = await fetch("/api/pollutants");
    const data = await res.json();
    const sel = document.getElementById("pollutantSelect");

    data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
    });
}

async function loadCities() {
    const res = await fetch("/api/cities");
    const cities = await res.json();
    const sel = document.getElementById("citySelect");

    cities.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
    });
}

function randomColor() {
    return "hsl(" + Math.floor(Math.random() * 360) + ", 70%, 45%)";
}

async function loadChart() {
    const pollutant = document.getElementById("pollutantSelect").value;

    const cities = [...document.getElementById("citySelect").selectedOptions]
        .map(o => o.value);

    if (cities.length === 0) {
        alert("Wybierz przynajmniej jedno miasto.");
        return;
    }

    const res = await fetch("/api/multi", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({cities, pollutant})
    });

    const rows = await res.json();

    if (chart) chart.destroy();

    const grouped = {};
    for (const r of rows) {
        const city = r[0];
        if (!grouped[city]) grouped[city] = [];
        grouped[city].push({date: r[1], value: r[2]});
    }

    const labels = [...new Set(rows.map(r => r[1]))];

    const datasets = Object.keys(grouped).map(city => ({
        label: city,
        data: grouped[city].map(e => e.value),
        borderColor: randomColor(),
        borderWidth: 2,
        fill: false
    }));

    chart = new Chart(document.getElementById("chart"), {
        type: "line",
        data: {labels, datasets},
        options: {responsive: true}
    });

    const statsTable = document.getElementById("statsTable");
    statsTable.innerHTML = `
        <tr>
            <th>Miasto</th>
            <th>Min</th>
            <th>Max</th>
            <th>Średnia</th>
            <th>Liczba dni</th>
        </tr>`;

    for (const city of cities) {
        const sRes = await fetch(`/api/stats/${city}/${pollutant}`);
        const s = await sRes.json();

        statsTable.innerHTML += `
            <tr>
                <td>${city}</td>
                <td>${s.min?.toFixed(1) || "-"}</td>
                <td>${s.max?.toFixed(1) || "-"}</td>
                <td>${s.avg?.toFixed(1) || "-"}</td>
                <td>${s.days}</td>
            </tr>`;
    }
}


document.addEventListener("DOMContentLoaded", async () => {
    await loadPollutants();
    await loadCities();
    document.getElementById("generateBtn").onclick = loadChart;
});
</script>

</body>
</html>
